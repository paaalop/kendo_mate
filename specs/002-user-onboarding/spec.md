# 기능 명세서: 사용자 온보딩 및 회원가입

**기능 브랜치**: `002-user-onboarding`  
**작성일**: 2026-01-30  
**상태**: 초안 (Draft)  
**입력**: 사용자 요청: "@docs/PRD.md 의 '3. 핵심 기능 상세 명세 - B. 사범님 등록 프로세스' 및 '4. 화면 구성 - [가입 Flow]' 섹션을 바탕으로 회원가입 및 온보딩 기능 명세서를 작성해 주세요. **상세 요구사항:** 1. **관장 가입 Flow:** * 계정 생성(이메일/비번) -> 도장(Tenant) 정보 입력(이름) -> dojos 테이블 생성 -> 본인 profiles 생성 및 role='owner' 자동 할당 -> 메인 대시보드 진입. 2. **관원/사범 가입 Flow:** * 계정 생성 -> 도장 검색(이름 검색) -> 가입 신청 폼 작성(본인 이름, 전화번호, 성인 여부, (미성년자일 경우) 보호자 전화번호) -> signup_requests 테이블에 status='pending'으로 저장 -> '승인 대기 중' 화면 출력. 3. **사범 등록 특이사항:** 별도의 사범 가입 페이지 없음. 관원으로 가입 후 관장이 승인 및 역할 변경을 통해 사범으로 지정하는 프로세스를 명확히 기술하세요. 4. **전화번호 입력 UX:** 사용자가 010-1234-5678로 입력하더라도 백엔드 전송 시 01012345678로 변환되는 로직을 UI 단에서 처리하도록 명세하세요."

## 질의응답 (Clarifications)
### 세션 2026-01-31
- Q: `signup_requests` 테이블에 신청 일시(`created_at`) 컬럼을 추가하여 목록 정렬에 사용해야 할까요? → A: 네, `created_at`을 추가하고 신청 오래된 순(FIFO)으로 정렬합니다.
- Q: 관장이 가입 신청을 거절(`reject`)한 경우, 해당 사용자가 즉시 다시 신청할 수 있도록 허용해야 할까요? → A: 네, 즉시 재신청 가능합니다 (거절 후 즉시 다른 도장 또는 같은 도장에 재신청 허용).
- Q: 관장이 멤버를 내보낸(`soft delete`) 후, 해당 사용자가 동일한 도장에 다시 가입 신청하여 승인될 경우 기존 프로필을 복구해야 할까요? → A: 네, 동일 도장 재가입 시 기존 프로필을 복구합니다 (기존 `deleted_at` 제거).
- Q: 도장 이름(`name`)의 중복 검사 시 대소문자를 구분해야 할까요? → A: 네, 대소문자 구분 없이 고유해야 합니다 (예: 'Kendo'와 'kendo'는 중복으로 간주).
- Q: 사용자가 도장을 직접 생성(`Owner Registration`)할 때, 이미 다른 도장에 보낸 가입 신청(`pending`)이 있다면 어떻게 처리해야 할까요? → A: 네, 도장 생성 시 기존 가입 신청은 자동 삭제됩니다.
- Q: 관장(Owner)이 탈퇴할 경우, 해당 도장과 소속 관원들의 데이터는 어떻게 처리하나요? → A: 도장 및 모든 하위 데이터(관원, 신청내역 등)를 즉시 영구 삭제합니다 (Cascade Hard Delete).
- Q: 가입 신청 승인(`approve`) 권한은 누구에게 있나요? (사범도 가능한가요?) → A: 오직 관장(Owner)만 승인 가능합니다.
- Q: 가입 신청을 완료한 후 사용자를 로그아웃시켜야 하나요? → A: 아니오, 로그인 상태를 유지하고 "승인 대기 중" 화면을 표시합니다.
- Q: 가입 신청 대기 중인 사용자가 다른 도장에 중복으로 신청할 수 있나요? → A: 아니오, 기존 신청을 취소해야만 다른 도장에 신청 가능합니다.
- Q: 이미 도장을 소유한 관장(Owner)이 다른 도장에 가입 신청을 보낼 수 있나요? → A: 아니오, 본인의 도장을 먼저 삭제(계정 탈퇴)해야만 다른 도장에 신청 가능합니다.

### 세션 2026-01-30
- Q: 가입 승인(Approval) 시, `signup_requests`에 입력된 **전화번호(Phone), 성인 여부(Is Adult), 보호자 전화번호(Guardian Phone)** 데이터는 어디로 이동해야 할까요? → A: `profiles` 테이블에 해당 컬럼들을 추가하여 관리합니다.
- Q: 한 명의 사용자가 여러 도장에 소속될 수 있는지(Multi-tenancy) 명확히 해야 합니다. → A: 아니오, 1 사용자 = 1 도장 원칙을 따릅니다 (MVP 복잡도 최소화).
- Q: 가입 승인 대기 상태(pending)인 사용자가 가입 취소(Cancel)를 하거나, 관장이 거절(Reject)할 경우 데이터 처리는 어떻게 하나요? → A: `signup_requests` 레코드를 삭제합니다 (Hard Delete).
- Q: 도장 검색 시, 정확히 일치(Exact Match)하는 이름만 검색하나요, 아니면 부분 일치(Partial Match/Contains) 검색도 허용하나요? → A: 부분 일치(Partial Match)를 허용합니다.
- Q: 도장 검색 결과 목록에 어떤 정보를 표시하여 동명 도장을 구분하나요? → A: 도장 이름과 관장 이름(Owner Name)을 함께 표시합니다.
- Q: 관장이 가입 신청 목록이나 멤버 관리 화면에서 특정인을 찾을 때 어떤 정보를 기준으로 검색하나요? → A: 이름, 전화번호, 보호자 연락처 모두 검색 대상에 포함합니다.
- Q: 관장이 승인 완료된 멤버를 도장에서 내보낼(Remove) 경우, 해당 `profiles` 데이터는 즉시 삭제하나요? → A: 아니오, `deleted_at` 필드를 활용한 Soft Delete로 처리합니다.
- Q: 프로필 이미지(Avatar) 업로드 기능을 MVP에 포함하나요? → A: 아니오 (MVP 범위 제외, 기본 Placeholder/이니셜 사용).
- Q: 도장 등록 시 사업자 등록 번호나 주소와 같은 추가 정보를 받나요? → A: 도장 이름만 받습니다 (MVP 단계에서는 최소 정보로 빠르게 시작).
- Q: 도장 등록(Owner Onboarding) 시, 관장의 실명과 전화번호도 함께 수집하나요? → A: 네, 관장 이름과 전화번호를 모두 입력받아 `profiles`에 저장합니다.
- Q: 새 가입 신청 발생 시 관장에게 알림을 보내나요? (이메일/SMS 등) → A: 아니오, 별도 알림 없이 대시보드 UI에서만 확인합니다 (MVP Scope).
- Q: 이미 존재하는 도장 이름으로 등록을 시도하면 어떻게 되나요? → A: 시스템이 생성을 차단합니다 (Unique Constraint 적용).
- Q: 한 사용자가 동시에 여러 도장에 가입 신청(Pending)을 할 수 있나요? → A: 아니오, 한 번에 하나의 도장에만 신청 가능합니다 (기존 신청 취소 후 재신청 필요).
- Q: 비밀번호 생성 시 보안 정책(길이, 복잡도 등)이 어떻게 되나요? → A: 최소 8자 이상 (숫자/문자 포함)이어야 합니다.
- Q: 관장이 가입 신청을 거절할 경우, 신청 데이터는 어떻게 처리되나요? → A: 즉시 삭제(Hard Delete)하여 사용자가 재신청할 수 있도록 합니다.
- Q: 가입 승인 대기 화면에서 승인이 완료되면 사용자 화면은 어떻게 변하나요? → A: 자동으로 메인 대시보드로 리다이렉트 됩니다 (새로고침 또는 폴링/구독 필요).

## 사용자 시나리오 및 테스트 (User Scenarios & Testing)

### User Story 1 - 관장 등록 및 도장 설정 (우선순위: P1)

새로운 도장 관장님이 회원가입 후 도장을 등록하고 관원 관리를 시작하려 합니다.

**우선순위 선정 이유**: 테넌트(도장)를 생성하는 진입점이므로, 이 기능 없이는 다른 사용자가 가입할 수 없습니다.

**독립 테스트 방법**: 신규 사용자로 가입하여 도장 이름을 입력하고 제출했을 때, 대시보드로 이동하며 데이터베이스에 도장 및 프로필이 생성되었는지 확인합니다.

**인수 조건 (Acceptance Scenarios)**:

1. **Given** 회원가입 페이지에서, **When** 이메일/비밀번호를 입력하고 제출하면, **Then** 계정이 생성된다.
2. **Given** 로그인된 신규 사용자가, **When** 도장 이름, 관장 이름, 전화번호를 입력하고 제출하면, **Then** `dojos` 테이블에 새 레코드가 생성되고, `profiles`에 `role='owner'`로 본인 정보가 생성되며, 메인 대시보드로 이동한다.

---

### User Story 2 - 관원/사범 가입 신청 (우선순위: P1)

예비 관원(또는 미래의 사범님)이 기존 도장에 가입하려고 합니다.

**우선순위 선정 이유**: 시스템 사용자를 확보하는 데 필수적인 기능입니다.

**독립 테스트 방법**: 테스트용 도장을 먼저 생성합니다. 다른 사용자로 가입하여 해당 도장을 검색하고 신청서를 제출한 뒤, `signup_requests` 테이블을 확인합니다.

**인수 조건 (Acceptance Scenarios)**:

1. **Given** 신규 사용자 계정으로, **When** 도장 이름으로 검색하면, **Then** 해당 도장이 결과에 나타난다.
2. **Given** 선택된 도장에서, **When** 가입 신청 폼(이름, 전화번호 `010-1234-5678`, 성인 여부)을 작성하고 제출하면, **Then** `signup_requests`에 `status='pending'` 및 전화번호 `01012345678`(하이픈 제거)로 저장된다.
3. **Given** 신청서를 제출한 후, **When** 페이지를 보면, **Then** "승인 대기 중" 화면이 표시된다.
4. **Given** 미성년자(성인 여부 = false)인 경우, **When** 폼을 작성할 때, **Then** "보호자 전화번호" 필드가 필수로 요구된다.

---

### User Story 3 - 사범 승급 (우선순위: P2)

도장 관장님이 특정 관원을 사범님으로 지정하려 합니다.

**우선순위 선정 이유**: "사범으로 가입하기" 기능이 별도로 없으므로, 권한 부여를 위해 필수적입니다.

**독립 테스트 방법**: 관장 계정으로 로그인하여 대기 중인 신청을 승인하고, 해당 관원을 승급시킵니다. `profiles` 테이블의 역할 변경을 확인합니다.

**인수 조건 (Acceptance Scenarios)**:

1. **Given** 대기 중인 가입 신청이 있을 때, **When** 관장이 이를 승인하면, **Then** `profiles` 테이블에 일반 관원(`role='member'`)으로 생성된다.
2. **Given** 기존 관원이 있을 때, **When** 관장이 관리 UI에서 역할을 "사범"으로 변경하면, **Then** `profiles`의 `role`이 `instructor`로 업데이트된다.

### 예외 케이스 (Edge Cases)

- **도장 이름 중복**: 시스템이 생성을 차단하고 에러 메시지를 표시해야 합니다 (Unique Constraint).
- **중복 신청**: 이미 `pending` 상태의 신청이 있는 경우 새로운 신청을 제출할 수 없습니다. 기존 신청을 취소하도록 안내해야 합니다.
- **잘못된 전화번호 형식**: 파싱/변환할 수 없는 전화번호 입력 시 유효성 검사 에러를 표시해야 합니다.
- **보호자 정보 누락**: 미성년자가 보호자 정보 없이 제출을 시도하면 폼 유효성 검사에서 차단해야 합니다.

## 요구사항 (Requirements)

### 기능 요구사항 (Functional Requirements)

- **FR-001**: 시스템은 사용자가 이메일과 비밀번호를 사용하여 계정을 생성할 수 있도록 해야 합니다.
- **FR-002**: 시스템은 신규 관장이 도장 이름, 관장 이름, 전화번호를 입력하여 새 테넌트(`dojos`)와 관장 프로필을 생성할 수 있도록 해야 합니다. 생성 시, 해당 사용자의 기존 `pending` 가입 신청은 자동 삭제되어야 합니다.
- **FR-003**: 시스템은 도장을 생성하는 사용자에게 자동으로 `role='owner'`를 할당해야 합니다.
- **FR-004**: 시스템은 사용자가 이름으로 도장을 검색(부분 일치)할 수 있게 하고, 중복 구분을 위해 **도장 이름**과 **관장 이름**을 함께 표시해야 합니다.
- **FR-005**: 시스템은 관원 가입 시 다음 정보를 수집해야 합니다: 이름, 전화번호, 성인 여부(Boolean), 보호자 전화번호(미성년자인 경우).
- **FR-006**: 시스템은 관원 가입 데이터를 `signup_requests` 테이블에 `status='pending'` 상태로 저장해야 합니다.
- **FR-007**: 시스템은 가입 신청 제출 후 사용자의 로그인 상태를 유지하고 "승인 대기 중" 화면을 표시해야 합니다.
- **FR-008**: 시스템은 전화번호 입력 시 하이픈을 제거하는 로직(예: `010-1234-5678` -> `01012345678`)을 구현하여 백엔드에 저장해야 합니다.
- **FR-009**: 시스템은 **오직** 관장만이 `signup_requests`를 승인할 수 있도록 해야 합니다. 동일 도장에 Soft Delete된 프로필이 있다면 복구(`deleted_at` 초기화)하고, 없다면 새로운 `profiles` 레코드를 생성(`role='member'`)해야 합니다.
- **FR-010**: 시스템은 관장이 관원을 `role='instructor'`(사범)로 승급시킬 수 있도록 해야 합니다.
- **FR-011**: 시스템은 1 사용자 = 1 도장 정책을 엄격히 적용해야 합니다. 한 사용자가 동시에 여러 도장의 관원이나 관장이 될 수 없습니다.
- **FR-012**: 시스템은 관장이 신청을 거절하거나 **사용자가 자신의 대기 중인 신청을 취소**할 경우, `signup_requests` 레코드를 삭제하여 즉시 재신청이 가능하도록 해야 합니다.
- **FR-013**: 시스템은 신규 가입 신청에 대해 외부 알림(이메일/SMS)을 발송하지 않으며, 관장은 대시보드에서 직접 확인해야 합니다.
- **FR-014**: 시스템은 도장 이름의 중복을 허용하지 않으며, 대소문자를 구분하지 않고(Case-Insensitive) 검사해야 합니다.
- FR-015: 시스템은 사용자가 한 번에 하나의 활성 `signup_request` (status='pending')만 가질 수 있도록 제한해야 합니다. 다른 도장에 신청하려면 기존 신청을 취소해야 합니다.
- FR-016: 시스템은 비밀번호 정책으로 최소 8자 이상, 영문과 숫자를 혼용하도록 강제해야 합니다. (특수문자 포함 허용)
- FR-017: 시스템은 승인된 관원을 "승인 대기 중" 화면에서 메인 대시보드로 자동 리다이렉트해야 합니다.
- **FR-018**: 시스템은 관장이 이름, 전화번호, 보호자 전화번호를 통해 관원이나 가입 신청을 검색할 수 있도록 해야 합니다.
- **FR-019**: 시스템은 가입 신청 목록을 신청 시간 오름차순(FIFO)으로 정렬하여 표시해야 합니다.
- **FR-020**: 시스템은 도장 관장이 계정을 삭제할 경우, 해당 도장(`dojos`)과 관련된 모든 데이터(`profiles`, `signup_requests`)를 영구 삭제(Cascade Hard Delete)해야 합니다.
- **FR-021**: 시스템은 도장을 소유한 관장이 다른 도장에 가입 신청을 보낼 수 없도록 차단해야 합니다.

### 주요 엔티티 (Key Entities)

- **dojos**: 테넌트/도장 정보. 컬럼: `id`, `name`, `created_at`.
- **profiles**: 도장 내 사용자 정보. 컬럼: `id` (auth.users 참조), `dojo_id`, `role` (owner, member, instructor), `name`, `phone`, `is_adult`, `guardian_phone`, `deleted_at`.
- **signup_requests**: 가입 요청 임시 저장. 컬럼: `id`, `user_id`, `dojo_id`, `status` (pending, approved, rejected), `name`, `phone`, `is_adult`, `guardian_phone`, `created_at`.

## 성공 기준 (Success Criteria)

### 측정 가능한 결과 (Measurable Outcomes)

- **SC-001**: 신규 관장은 3분 이내에 가입 및 도장 생성 프로세스를 완료할 수 있다.
- **SC-002**: 관원 가입 신청 데이터(특히 전화번호 포맷)는 100% 정확하게 저장된다.
- **SC-003**: 관장이 아닌 사용자의 가입 신청은 승인 전까지 100% `pending` 상태로 유지된다.
