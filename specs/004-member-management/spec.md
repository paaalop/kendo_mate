# 기능 명세서: 관원 관리 (Member Management)

**기능 브랜치**: `04-member-management`
**작성일**: 2026-02-01
**상태**: 초안 (Draft)
**입력**: 사용자 요구사항

## 명확화 사항 (Clarifications)

### 세션 2026-02-01
- Q: 소유자(Owner)가 자신의 권한을 스스로 강등(Demote)할 수 있어야 합니까? → A: **자진 강등 불가**. 소유권 이전을 통해서만 변경 가능하도록 제한합니다.
- Q: 관원 삭제 정책은 어떻게 되나요? → A: **Soft Delete**. `deleted_at` 타임스탬프를 업데이트하여 화면에서 숨기되 데이터는 보존합니다.
- Q: 1,000명 이상의 관원을 로드할 때의 UI 처리 방식은 무엇인가요? → A: **무한 스크롤 (Infinite Scroll)**. 사용자 경험과 성능을 위해 무한 스크롤 방식으로 데이터를 분할 로드합니다.
- Q: 사범(Instructor)의 권한 범위는 어디까지인가요? → A: **읽기 전용 (Read Only)**. 관원 목록 및 상세 정보 조회는 가능하지만, 가입 승인/삭제/권한 변경 등의 관리 작업은 불가능합니다.
- Q: 관원 목록의 기본 정렬 순서는 무엇인가요? → A: **이름 오름차순** (가나다순)으로 정렬하여 일관된 검색 경험을 제공합니다.
- Q: 관원 상세 정보에서 수정 가능한 항목은 무엇인가요? → A: **이름, 연락처, 보호자 정보**. (급수는 별도 기능으로 분리됨)
- Q: 관원 삭제 시 관련 데이터(출석, 승급 등)는 어떻게 되나요? → A: **모두 보존**. Soft Delete 방식이므로 연관된 모든 활동 기록은 데이터베이스에 유지됩니다.
- Q: 전화번호 검색 시 전체 번호로도 검색이 가능한가요? → A: **전체 번호 및 뒷번호 4자리** 모두 검색 가능하도록 지원합니다.
- Q: 관원 상세 정보에서 출석 기록은 몇 개까지 보여주나요? → A: **최근 10개**를 우선 표시하고, 추가 기록은 '더보기' 버튼을 통해 제공합니다.
- Q: 급수(Rank) 변경 방식은 무엇인가요? → A: **별도 승급 기능(Separate Action)**. 이력 관리를 위해 정보 수정 폼이 아닌 별도의 승급 기능을 통해 변경합니다.

## 사용자 시나리오 및 테스트 (User Scenarios & Testing) *(필수)*

### 사용자 스토리 1 - 가입 요청 처리 (우선순위: P1)

도장 관장(Owner)으로서, 대기 중인 가입 요청을 검토하여 올바른 회원은 승인하고 유효하지 않은 요청은 거절함으로써 검증된 회원 목록을 유지하고 싶다.

**우선순위 선정 이유**: 신규 회원을 시스템에 등록하기 위한 필수 과정입니다. 이 기능 없이는 새로운 사용자가 애플리케이션에 접근할 수 없습니다.

**독립 테스트**: 데이터베이스에 더미 가입 요청을 생성하고, 관장이 UI를 통해 이를 승인/거절할 수 있는지 확인합니다.

**인수 시나리오**:

1. **Given** 대기 중인 가입 요청 목록이 있을 때, **When** 특정 요청의 '승인' 버튼을 클릭하면, **Then** 새로운 회원 프로필이 생성되고 요청 상태가 '승인됨(approved)'으로 변경된다.
2. **Given** 대기 중인 가입 요청 목록이 있을 때, **When** 특정 요청의 '거절' 버튼을 클릭하면, **Then** 요청 상태가 '거절됨(rejected)'으로 변경되고 프로필은 생성되지 않는다.
3. **Given** 대기 중인 요청이 없을 때, **When** 승인 대기열을 조회하면, **Then** '대기 중인 요청이 없습니다'라는 메시지가 표시된다.

---

### 사용자 스토리 2 - 관원 검색 및 목록 조회 (우선순위: P1)

도장 관장(Owner) 또는 사범(Instructor)으로서, 전체 관원 목록을 조회하고 이름이나 전화번호로 특정 인원을 검색하여 필요한 정보에 빠르게 접근하고 싶다.

**우선순위 선정 이유**: 가장 기본적인 탐색 및 관리 기능입니다.

**독립 테스트**: 다수의 관원 데이터를 DB에 입력하고, 검색어가 입력되었을 때 결과가 일치하는지 확인합니다.

**인수 시나리오**:

1. **Given** 관원 목록이 있을 때, **When** 검색창에 이름을 입력하면, **Then** 이름이 일치하는 관원만 표시된다.
2. **Given** 관원 목록이 있을 때, **When** 전체 전화번호 또는 뒷번호 4자리를 입력하면, **Then** 번호가 일치하는 관원만 표시된다.
3. **Given** 일치하는 관원이 없을 때, **When** 검색을 시도하면, **Then** '검색 결과가 없습니다' 메시지가 표시된다.
4. **Given** Soft Delete된 관원이 있을 때, **When** 해당 관원을 검색하면, **Then** 결과에 나타나지 않는다.

---

### 사용자 스토리 3 - 사범 권한 관리 (우선순위: P1 - Critical)

도장 관장(Owner)으로서, 신뢰할 수 있는 관원을 사범(Instructor)으로 승급시켜 도장 관리 업무를 위임하고 싶다.

**우선순위 선정 이유**: 관리 책임 위임을 위해 중요하며, 보안에 민감한 기능입니다.

**독립 테스트**: 관장 계정과 사범 계정으로 각각 로그인하여 승급 UI의 노출 여부를 확인합니다.

**인수 시나리오**:

1. **Given** 관장으로 로그인한 상태에서, **When** 관원 상세 페이지를 조회하면, **Then** 역할을 '관원'에서 '사범'으로 변경할 수 있는 옵션이 보인다.
2. **Given** 사범이나 일반 관원으로 로그인한 상태에서, **When** 관원 상세 페이지를 조회하면, **Then** 역할 변경 옵션이 보이지 않는다.
3. **Given** 관장으로 로그인한 상태에서, **When** 관원의 역할을 '사범'으로 변경하면, **Then** 변경 사항이 즉시 저장되고 반영된다.
4. **Given** 관장으로 로그인한 상태에서, **When** 자신의 역할을 변경하려고 시도하면, **Then** 시스템이 이를 차단하고 경고 메시지를 표시한다.

---

### 사용자 스토리 4 - 관원 상세 정보 조회 (우선순위: P2)

도장 관장(Owner) 또는 사범(Instructor)으로서, 관원의 상세 정보(수련 진행 상황, 연락처 등)를 조회하여 관리하고 싶다.

**우선순위 선정 이유**: 일상적인 관리에 필요하지만 목록 조회(스토리 2)에 의존적입니다.

**독립 테스트**: 목록에서 관원을 클릭했을 때 모든 상세 데이터가 올바르게 표시되는지 확인합니다.

**인수 시나리오**:

1. **Given** 관원 목록에서, **When** 관원 카드를 클릭하면, **Then** 기본 정보, 보호자 정보(해당 시), 현재 급수, 누적 출석 횟수가 표시된다.

---

### 사용자 스토리 5 - 관원 삭제 (우선순위: P2)

도장 관장(Owner)으로서, 도장을 떠난 관원을 목록에서 제거하여 명단을 최신 상태로 유지하고 싶다.

**우선순위 선정 이유**: 정확한 활성 회원 명부 관리를 위해 필요합니다.

**독립 테스트**: 관원을 삭제했을 때 목록에서는 사라지지만 DB에는 타임스탬프와 함께 남아있는지 확인합니다.

**인수 시나리오**:

1. **Given** 관장으로 로그인한 상태에서, **When** 관원 프로필의 '삭제' 버튼을 클릭하면, **Then** 삭제 확인 팝업이 표시된다.
2. **Given** 삭제를 확인하면, **Then** 해당 관원은 활성 목록에서 제거되고 `deleted_at` 필드가 업데이트된다.
3. **Given** 사범으로 로그인한 상태에서, **When** 관원 프로필을 조회하면, **Then** 삭제 버튼이 보이지 않는다.

### 엣지 케이스 (Edge Cases)

- 가입 요청 승인 후 프로필 생성에 실패하면 어떻게 되는가? (트랜잭션 롤백 필요)
- 동일한 요청을 동시에 승인하려고 하면 어떻게 되는가? **결과**: 시스템은 DB 수준의 잠금(Locking)을 사용해야 하며, 두 번째 시도는 명확한 에러 메시지와 함께 실패해야 합니다.
- 관장이 스스로를 강등하려고 하면 어떻게 되는가? **결과**: 시스템은 이 동작을 차단하고 경고 메시지를 표시해야 합니다.
- 이미 삭제된 관원을 다시 삭제하려고 하면? (이미 목록에서 숨겨져 있어야 함)

## 요구사항 (Requirements) *(필수)*

### 기능 요구사항 (Functional Requirements)

- **FR-001**: 시스템은 상태가 'pending'인 가입 요청 목록을 표시해야 한다.
- **FR-002**: 시스템은 **오직 관장(Owner)**만이 가입 요청을 '승인'할 수 있도록 해야 한다.
  - 동작: `profiles` 테이블에 레코드 추가.
  - 동작: `signup_requests.status`를 'approved'로 업데이트.
- **FR-003**: 시스템은 **오직 관장(Owner)**만이 가입 요청을 '거절'할 수 있도록 해야 한다.
  - 동작: `signup_requests.status`를 'rejected'로 업데이트 (기록 보존).
- **FR-004**: 시스템은 검색 인터페이스를 제공하고 **무한 스크롤(Infinite Scroll)**을 통해 1000명 이상의 관원을 효율적으로 로드해야 한다.
  - 동작: 이름 OR 전체 전화번호 OR 뒷번호 4자리로 필터링.
  - 동작: 기본 정렬은 **이름 오름차순**.
  - 제약: 초기 로드 및 추가 스크롤 시 적절한 크기의 데이터 청크를 가져와야 함.
- **FR-005**: 시스템은 관원의 모든 상세 정보를 하나의 통합된 뷰에서 보여주어야 한다.
  - 포함 정보: 기본 정보(이름 등), 보호자 정보, 현재 급수, 누적 출석 횟수.
  - 출석 기록: **최근 10건**을 우선 표시하고 '더보기' 옵션 제공.
- **FR-006**: 시스템은 **오직 관장(Owner)**만이 관원의 역할을 변경(관원 ↔ 사범)할 수 있도록 해야 한다.
- **FR-008**: 시스템은 관장이 아닌 사용자에게 관리 UI(승인, 거절, 삭제, 역할 변경)를 숨겨야 한다.
- **FR-009**: 시스템은 관장(Owner)이 자신의 역할을 다른 역할로 변경하는 것을 방지해야 한다.
- **FR-010**: 시스템은 **오직 관장(Owner)**만이 관원을 'Soft Delete' 할 수 있도록 해야 한다.
  - 동작: `deleted_at`을 현재 타임스탬프로 설정.
  - 제약: 삭제된 관원은 기본 목록 및 검색 결과에서 제외되어야 함.
  - 제약: 연관된 모든 데이터(출석, 승급 기록 등)는 DB에 보존되어야 함.
- **FR-011**: 시스템은 관장(Owner)이 관원의 상세 정보(이름, 전화번호, 보호자 정보)를 수정할 수 있도록 해야 한다.
  - 제약: `role`, `rank`, `created_at`, `id`와 같은 내부 필드는 이 뷰에서 수정할 수 없음.
- **FR-012**: 시스템은 관장(Owner)이 별도의 기능을 통해 관원의 급수(Rank)를 승급/수정할 수 있도록 해야 한다.
  - 동작: `profiles` 테이블의 급수 업데이트.
  - 동작: 승급 이력(`rank_history`)에 기록 생성.

### 주요 엔티티 (Key Entities)

- **Signup Request (가입 요청)**: 사용자의 도장 가입 신청. 상태(대기, 승인, 거절)를 포함.
- **Profile (관원 프로필)**: 도장의 정식 관원. 급수, 역할(관원, 사범, 관장), 개인 정보를 포함.

### 가정 및 의존성 (Assumptions & Dependencies)

- **가정**: 사용자(관장)는 이미 로그인되어 있으며 적절한 권한을 가지고 있다고 가정합니다.
- **의존성**: `signup_requests` 테이블은 기존 가입 프로세스(이 기능의 범위 밖)에 의해 데이터가 채워져 있어야 합니다.
- **의존성**: `profiles` 테이블 스키마는 `signup_requests`의 데이터와 호환되어야 합니다.

## 성공 기준 (Success Criteria) *(필수)*

### 측정 가능한 결과

- **SC-001**: 관장은 대기 중인 가입 요청을 3번의 클릭 이내에 승인할 수 있다.
- **SC-002**: 1000명의 관원 데이터베이스에서 검색 결과는 1초 이내에 표시된다 (삭제된 관원 제외).
- **SC-003**: 역할 승급 옵션은 관장에게는 100% 노출되고, 비관장에게는 0% 노출된다.
- **SC-004**: 승인된 가입 요청은 100% 확률로 대응되는 Profile 레코드를 생성한다.